/*1359355314,173213215*/

if (self.CavalryLogger) { CavalryLogger.start_js(["SIWrR"]); }

__d("LiveListenNux",["Arbiter","HoverFlyout","JSLogger","MusicConstants","$"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('HoverFlyout'),i=b('JSLogger'),j=b('MusicConstants'),k=b('$'),l=i.create('music_live_listen'),m=(function(){var n=null,o=null,p=[],q=false;return {init:function(){if(q)return;q=true;g.subscribe(j.LIVE_LISTEN_OP.QUEUING_SESSION,m.destroy);},setFlyout:function(r){m.init();n=r;o=new h();o.init(n);p.forEach(m.registerButton);o.subscribe('show',function(){l.log('show_nux');});},destroy:function(){if(o){o.hideFlyout(true);o.destroy();n.destroy();}o=null;n=null;},registerButton:function(r){if(o){o.initNode(r);}else p.push(r);},registerButtonById:function(r){this.registerButton(k(r));}};})();e.exports=a.LiveListenNux||m;});
__d("legacy:LiveListenNux",["LiveListenNux"],function(a,b,c,d){a.LiveListenNux=b('LiveListenNux');},3);
__d("MusicLogger",["AsyncRequest","JSLogger","MusicConstants","Run"],function(a,b,c,d,e,f){var g=b('AsyncRequest'),h=b('JSLogger'),i=b('MusicConstants'),j=b('Run'),k=5000,l=h.create('music_logger'),m=null,n={};function o(){m=null;}function p(){if(!m){l.debug('queue_dispatch',k);m=q.defer(k,false);}}function q(s){l.debug('dispatch',{onUnload:s,messages:n});o();if(Object.keys(n).length>0){var t=JSON.stringify(n);n={};var u=new g().setURI('/ajax/music/log.php').setData({types:t});if(s)u.setOption('asynchronous',false);u.send();}}j.onUnload(q.curry(true));var r={PLATFORM:'platform',STATUS_EVENT_VIA:'status_event',BUMP_KEY:'bump_key',log:function(s,t){if(s===r.STATUS_EVENT_VIA)if(t.op!==i.OP.PLAY&&t.op!==i.STATUS_CHANGE_EVENT.playing&&t.op!==i.STATUS_CHANGE_EVENT.track)return;n[s]=n[s]||[];n[s].push(t);p();},dispatchNow:q};e.exports=a.MusicLogger||r;});
__d("MusicProviders",[],function(a,b,c,d,e,f){e.exports=a.MusicProviders={SPOTIFY:'open.spotify.com'};});
__d("SpotifyAjaxRequest",["ArbiterMixin","ErrorUtils","JSLogger","URI","copyProperties","emptyFunction"],function(a,b,c,d,e,f){var g=b('ArbiterMixin'),h=b('ErrorUtils'),i=b('JSLogger'),j=b('URI'),k=b('copyProperties'),l=b('emptyFunction'),m=i.create('music_spotify'),n=function(){this._request=null;this._data={};this._option={timeout:30000,method:'GET'};this._timeout=null;};k(n,{LOAD_ERROR:'LOAD_ERROR',TIMEOUT_ERROR:'TIMEOUT_ERROR',PARSE_ERROR:'PARSE_ERROR',isSupported:function(){return window.XMLHttpRequest&&typeof XDomainRequest!=='undefined'||('withCredentials' in new XMLHttpRequest());}});k(n.prototype,g,{getDebugData:function(){return {uri:this._uri,data:this._data,options:this._option};},setData:function(o){this._data=o;return this;},setOption:function(o,p){this._option[o]=p;return this;},setURI:function(o){this._uri=j(o);return this;},makeRequestAndOpen:function(){var o=new XMLHttpRequest();if('withCredentials' in o){o.open(this._option.method,this._uri.toString(),true);}else if(typeof XDomainRequest!=='undefined'){o=new XDomainRequest();o.open(this._option.method,this._uri.toString());}else{m.error('not_supported',this.getDebugData());throw new Error('SpotifyAjaxRequest: not supported');}return o;},send:function(){if(this.inform('initial',this)!==false){this._uri.addQueryData(k({cors:''},this._data));this._request=this.makeRequestAndOpen();this._request.ontimeout=l;this._request.onprogress=l;this._request.onload=this._parseResult.bind(this);this._request.onerror=this._dispatchResult.bind(this,'error',{error:{type:n.LOAD_ERROR,message:'the request failed to load at: '+this._uri}});if(this._option.timeout>0)this._timeout=this._dispatchResult.bind(this,'timeout',{error:{type:n.TIMEOUT_ERROR,message:'a timeout occurred after '+this._option.timeout+'ms'}}).defer(this._option.timeout,false);h.applyWithGuard(this._request.send,this._request,null,function(o){m.error('send_error',o);}.bind(this));}return this;},abort:function(){clearTimeout(this._timeout);try{this._request.abort();}catch(o){}this._request=null;this.inform('finish');return this;},_dispatchResult:function(o,p){clearTimeout(this._timeout);this.inform.bind(this,'finish',p).defer();this.inform(o,p);},_parseResult:function(){var o,p,q,r;try{o=this._request.responseText||'';}catch(s){p=n.LOAD_ERROR;q='responseText not available - '+s.message;}if(!p)try{r=JSON.parse(o);}catch(s){p=n.PARSE_ERROR;q='exception parsing JSON - '+s.message;}if(!p&&!r){p=n.PARSE_ERROR;q='empty JSON';}if(p){this._dispatchResult('error',{error:{type:p,message:q}});}else this._dispatchResult(r.error?'error':'success',r);}});e.exports=n;});
__d("SpotifyRemote",["ArbiterMixin","AsyncRequest","Bootloader","Dialog","DOM","JSLogger","MusicConstants","MusicDiagnostics","MusicEvents","MusicProviders","Run","SpotifyAjaxRequest","URI","UserAgent","copyProperties","emptyFunction","ge"],function(a,b,c,d,e,f){var g=b('ArbiterMixin'),h=b('AsyncRequest'),i=b('Bootloader'),j=b('Dialog'),k=b('DOM'),l=b('JSLogger'),m=b('MusicConstants'),n=b('MusicDiagnostics'),o=b('MusicEvents'),p=b('MusicProviders'),q=b('Run'),r=b('SpotifyAjaxRequest'),s=b('URI'),t=b('UserAgent'),u=b('copyProperties'),v=b('emptyFunction'),w=b('ge'),x=l.create('music_spotify'),y=null;function z(){}(function(){var aa=window.location.protocol==='https:';u(z.prototype,g,{PROTOCOL_VERSIONS:[9],serial:1,manualPlay:false,showLoggingin:false,oauthTokenInvalid:false,config:{play_now_url:'/ajax/music/spotify_play_now.php?init_only',oauth_step:8,set_installed_url:'/ajax/music/spotify/installed.php',csrf_uri:'/ajax/music/spotify/set_csrf.php',fetch_oauth_url:'/ajax/music/spotify/auth.php?going_online',retryPeriod:3000,iframeUpdatePeriod:10000,iframeTryCycles:3,longPollPeriod:60000,optimisticPlayNowTime:1000,loggingInTimeout:15000,defaultTimeout:4000,pingPortsTimeout:4000,expBackoffFactor:1.2,maxPollInterval:2200,apPollTimeout:8000},responseCallback:v,tokens:{spotify_csrf:'',spotify_oauth:'',last_timestamp:0},serverConfig:{url:window.location.protocol+'//'+((Math.random()*10000)|0)+'.spotilocal.com',start_port:aa?4370:4380,end_port:aa?4374:4384,path:'/',callbackParam:'callback',ops:{STATUS:'remote/status.json',RESUME:'remote/pause.json?pause=false',PAUSE:'remote/pause.json?pause=true',PLAY:'remote/play.json',VERSION:'service/version.json?service=remote',GET_IFRAME_RESPONSE:'csrf/getFbCsrfToken.html',LOGIN:'remote/login.json'}},STATES:{OFFLINE:'OFFLINE',RESIGNED:'RESIGNED',SEARCHING:'SEARCHING',AUTHENTICATING:'AUTHENTICATING',LOGGED_OUT_AND_WAITING:'LOGGED_OUT_AND_WAITING',FETCHING_OAUTH:'FETCHING_OAUTH',IFRAME_POLLING:'IFRAME_POLLING',RETRYING_TOKENS:'RETRYING_TOKENS',WAITING_TO_AUTH:'WAITING_TO_AUTH',LOGGING_IN:'LOGGING_IN',ONLINE:'ONLINE'},init:function(ba,ca){this._iframeTryCount=0;this._providerArgs=ca;this._switchToState(this.STATES.OFFLINE);ba&&this.setResponseCallback(ba);this.uri=new s(this.serverConfig.url||'');this.uri.setPath(this.serverConfig.path||'');if(ca.fb_csrf)this.fb_csrf=ca.fb_csrf;if(!this.serverConfig.start_port)this.serverConfig.start_port=this.serverConfig.port||80;this._hasXDomainXHR=r.isSupported();},persistSearchingFor:function(ba){this._persistFor=ba;var ca=this._persistentLoopTimer;this._resetPersistenceTimers();if(ca&&this._persistFor)this._persistentLoopTimer=this._giveUpPersisting.bind(this,this._persistFor).defer(this._persistFor*1000,false);},serviceRunning:function(){switch(this.state){case this.STATES.LOGGED_OUT_AND_WAITING:case this.STATES.IFRAME_POLLING:case this.STATES.RETRYING_TOKENS:case this.STATES.FETCHING_OAUTH:case this.STATES.LOGGING_IN:case this.STATES.ONLINE:return true;default:return false;}},attemptGoOnline:function(ba){this.manualPlay=ba;if(!this._hasXDomainXHR&&aa||t.opera()){if(this.manualPlay)j.bootstrap('/ajax/music/spotify/unsupported_browser.php');return;}switch(this.state){case this.STATES.OFFLINE:case this.STATES.RESIGNED:var ca=this.serverConfig.start_port||this.serverConfig.port;ca&&this.uri.setPort(ca);this._switchToState(this.STATES.SEARCHING);this.responseCallback(m.DIAGNOSTIC_EVENT.SEARCHING);if(this._hasXDomainXHR){this._pingPorts();}else i.loadModules(['SpotifyJSONPRequest'],function(da){y=da;this._pingPorts();}.bind(this));break;case this.STATES.LOGGED_OUT_AND_WAITING:if(this.manualPlay){this._switchToState(this.STATES.LOGGING_IN);this._send(m.STATUS_CHANGE_OP.LOGIN);}}this.persistSearchingFor(this._persistFor);},reconnect:function(){if(this.state===this.STATES.IFRAME_POLLING){this._cleanupIframe();}else if(this.state===this.STATES.FETCHING_OAUTH){this.fetchedOauth=true;this.oauthTokenInvalid=false;}else{x.error('invalid_reconnect',this.state);return;}this._switchToState(this.STATES.RETRYING_TOKENS);this._send(m.STATUS_CHANGE_OP.STATUS);},setShowLoggingin:function(ba){this.showLoggingin=ba;},setTokens:function(ba,ca){ba=ba||{};var da=this.tokens.last_timestamp<ca;if(ba.spotify_csrf&&(!this.tokens.spotify_csrf||da))this.tokens.spotify_csrf=ba.spotify_csrf;if(ba.spotify_oauth&&(!this.tokens.spotify_oauth||da))this.tokens.spotify_oauth=ba.spotify_oauth;if(da&&(ba.spotify_csrf||ba.spotify_oauth))this.tokens.last_timestamp=ca;},goOnline:function(){x.log('go_online',{port:this.uri.getPort(),from_state:this.state});this._switchToState(this.STATES.ONLINE);this._stopPersisting();this.oauthTokenInvalid=false;this._iframeTryCount=0;this.responseCallback(m.DIAGNOSTIC_EVENT.ONLINE);this._startPolling();new h(this.config.set_installed_url).setData({set:true,csrf:this.tokens.spotify_csrf}).send();},goOffline:function(){x.log('go_offline',{port:this.uri.getPort(),from_state:this.state});this._switchToState(this.STATES.OFFLINE);clearTimeout(this._authenticatingRetry);this._cleanupIframe();this._stopPersisting();this.oauthTokenInvalid=false;this.fetchedOauth=false;this._iframeTryCount=0;this.responseCallback(m.DIAGNOSTIC_EVENT.OFFLINE);},displayError:function(ba,ca){x.error('display_error',{error_code:ba,extra_data:ca});var da=this._getDisplayErrorParams(ba,ca);j.bootstrap('/ajax/music/play_error.php',da);},_getDisplayErrorParams:function(ba,ca){var da={code:ba,provider:p.SPOTIFY};ca=ca||{};if(ca.error_url)da.url=ca.error_url;if(ca.song)da.song=ca.song;return da;},launchPlayNowDialog:function(ba){if(this.state!==this.STATES.LOGGED_OUT_AND_WAITING&&this.serviceRunning())return;this._resetLaunchSubscription();var ca=this._launchPlayNow.bind(this,ba);this.prePlayNowLaunchTimer=ca.defer(this.config.optimisticPlayNowTime,false);this.launchSubscription=this.subscribe([m.DIAGNOSTIC_EVENT.STATE_CHANGE,m.DIAGNOSTIC_EVENT.WRONG_VERSION],function(da,ea){if(da===m.DIAGNOSTIC_EVENT.WRONG_VERSION){this._resetLaunchSubscription();}else switch(ea.to){case this.STATES.OFFLINE:case this.STATES.RESIGNED:this._resetLaunchSubscription();ca();break;case this.STATES.AUTHENTICATING:this._resetLaunchSubscription();n.userAction.curry(p.SPOTIFY,n.LAUNCH_NOT_NEEDED).defer();break;}}.bind(this));this.attemptGoOnline(true);},send:function(ba,ca){if(this.state===this.STATES.ONLINE){this.responseCallback(m.DIAGNOSTIC_EVENT.LOG_SEND_OP,{op:ba,params:ca});this._send(ba,m.sanitizeForProviders(ca));}else this.responseCallback(m.DIAGNOSTIC_EVENT.REQUEUE_OP,{op:ba,params:ca});},setResponseCallback:function(ba){this.responseCallback=ba;},_send:function(ba,ca){var da=false;if(ba===m.OP.PLAY&&ca){da={uri:ca.uri};if(ca.playlist){da.context=ca.playlist;}else if(ca.album){da.context=ca.album;}else if(ca.song_list){var ea=ca.song_list.indexOf(ca.uri),fa=ca.song_list.map(function(ja){return ja.replace(/.*\//,'');});da.context='spotify:trackset:'+escape(ca.title||'Facebook')+':'+fa.join(',');}if(ca.offset){var ga=Math.floor(ca.offset/60),ha=ca.offset%60;da.uri+='#'+ga+':'+ha;}if(ca.request_id)da.request_id=ca.request_id;if(ca.listen_with_friends)da.listen_with_friends=ca.listen_with_friends;}var ia=da||ca;if(ia&&ia.request_id)ia.request_id=ia.request_id+'';this._createOpRequest(ba,ia).send();n.sendUpdate.curry(p.SPOTIFY,ba,ia).defer();},_launchPlayNow:function(ba){this._resetLaunchSubscription();var ca=ba&&ba.context&&ba.context.button_id;j.bootstrap(this.config.play_now_url,ba,null,null,null,w(ca));},_resetLaunchSubscription:function(){clearTimeout(this.prePlayNowLaunchTimer);this.launchSubscription&&this.unsubscribe(this.launchSubscription);},_pingPorts:function(){var ba=this.serverConfig.end_port||this.serverConfig.start_port;this.portAttemptCount=ba-this.serverConfig.start_port+1;for(var ca=this.serverConfig.start_port;ca<=ba;ca++){this.uri.setPort(ca);this._createOpRequest(m.OP.VERSION).send();}},_stopPersisting:function(){this._persistFor=0;this._resetPersistenceTimers();return this;},_resetPersistenceTimers:function(){clearTimeout(this._persistentLoopTimer);clearTimeout(this._persistentLoopIterationTimer);this._persistentLoopTimer=null;this.loopIterationTime=1000;},_giveUpPersisting:function(ba){x.warn('give_up_persisting',ba);this._stopPersisting();},_pingPortsModeResign:function(){if(this._persistFor){var ba=this.loopIterationTime*this.config.expBackoffFactor;if(ba<this.config.maxPollInterval)this.loopIterationTime=ba;this._persistentLoopIterationTimer=this.attemptGoOnline.bind(this,this.manualPlay).defer(this.loopIterationTime,false);x.debug('persistence_connection_failed','retry in: '+(this.loopIterationTime/1000));this._switchToState(this.STATES.RESIGNED);}else this.goOffline();},_startPolling:function(){if(this.state!==this.STATES.ONLINE||!window.loaded)return false;q.onAfterLoad((function(){this._latestRequest=this._createOpRequest(m.STATUS_CHANGE_OP.STATUS,{returnon:'login,logout,play,error,ap',returnafter:this.config.longPollPeriod/1000});this._latestRequest.subscribe('finish',this._startPolling.bind(this));this._latestRequest.send();}).bind(this));},_pollForAP:function(){this._createOpRequest(m.STATUS_CHANGE_OP.STATUS,{returnon:'ap',returnafter:this.config.apPollTimeout/1000}).send();},_createOpRequest:function(ba,ca){if(!this.serverConfig.ops[ba]){x.error('invalid_op',ba);return false;}var da=this.config.defaultTimeout;if(ca&&ca.returnon){da=0;}else if(this.state===this.STATES.SEARCHING){da=this.config.pingPortsTimeout;}else if(this.state===this.STATES.LOGGING_IN)da=this.config.loggingInTimeout;var ea=this._hasXDomainXHR?new r():new y();ea.setOption('callbackParam',this.serverConfig.callbackParam).setOption('timeout',da).setData(u({csrf:this.tokens.spotify_csrf,oauth:this.tokens.spotify_oauth},(ca||{}))).setURI(this.uri.toString()+this.serverConfig.ops[ba]);var fa=this.uri.getPort();x.debug('create_op_request',ea.getDebugData());ea.subscribe('success',this._respondToSuccess.bind(this,ba,fa));ea.subscribe('error',this._respondToError.bind(this,ba,fa));ea.subscribe('timeout',this._respondToError.bind(this,ba,fa));return ea;},_respondToSuccess:function(ba,ca,da,ea){x.debug('respond_to_success',{op:ba,port:ca,response_data:ea});this.uri.setPort(ca);if(ea.hasOwnProperty('online')&&!ea.online)if(this.state!=this.STATES.WAITING_TO_AUTH){this._switchToState(this.STATES.WAITING_TO_AUTH);this._pollForAP();return;}else{this.manualPlay&&this.displayError(4);this.goOffline();}switch(this.state){case this.STATES.SEARCHING:var fa=ea.client_version,ga=ea.version;if(this._isValidClient(fa,ga)){this._switchToState(this.STATES.AUTHENTICATING);this._send(m.STATUS_CHANGE_OP.STATUS);}else{x.error('connecting_schema_version_mismatch',{client_version:fa,protocol_version:ga});this.inform(m.DIAGNOSTIC_EVENT.WRONG_VERSION);if(this.manualPlay)j.bootstrap('/ajax/music/spotify/version_mismatch.php');this.goOffline();return;}break;case this.STATES.LOGGING_IN:case this.STATES.RETRYING_TOKENS:case this.STATES.AUTHENTICATING:this.goOnline();break;case this.STATES.WAITING_TO_AUTH:if(ea.online){this.goOnline();}else{this.manualPlay&&this.displayError(4);this.goOffline();}break;case this.STATES.RESIGNED:case this.STATES.OFFLINE:return;}ea=ea?this._convertURIFields(ea):{};this.error_count=0;this.responseCallback(ba,ea);},_respondToError:function(ba,ca,da,ea){switch(this.state){case this.STATES.SEARCHING:x.debug('connect_miss',ca);if(--this.portAttemptCount<=0)this._pingPortsModeResign();return;case this.STATES.RESIGNED:case this.STATES.OFFLINE:x.debug('offline_or_resigned',this.state);return;}if(ba===m.OP.VERSION){x.debug('stray_version');return;}var fa=v,ga=ea||{},ha=this._getError(ga.error.type);x.debug('respond_to_error',{op:ba,port:ca,error_code:ha,payload:ga});switch(ha){case 'SERVICE_DEPENDENT_ERRORS':var ia=this._getError(ga.error.type,true),ja=this._getDisplayErrorParams(ia,ga);n.userAction.curry(p.SPOTIFY,m.DIAGNOSTIC_EVENT.SERVICE_ERROR,ja).defer();if(m.STATUS_CHANGE_OP[ba]&&o.inform(m.DIAGNOSTIC_EVENT.SERVICE_ERROR,ja)!==false&&m.ERROR[ia]!=='AUDIO_AD_PLAYING')this.displayError(ia,ga);break;case 'PARSE_ERROR':case 'LOAD_ERROR':case 'TIMEOUT_ERROR':case 'SERVICE_NOT_RESPONDING':case 'UNKNOWN_SERVICE':case 'UNKNOWN_METHOD':case 'ERROR_PARSING_REQUEST':clearTimeout(this._authenticatingRetry);if(ha=='SERVICE_NOT_RESPONDING'&&this.state===this.STATES.AUTHENTICATING){fa=this._pingPortsModeResign;break;}fa=this._loadError;if(this.state===this.STATES.AUTHENTICATING||this.state===this.STATES.RETRYING_TOKENS){this._authenticatingRetry=this._send.bind(this,m.STATUS_CHANGE_OP.STATUS).defer(this.config.retryPeriod,false);}else if(this.state===this.STATES.LOGGING_IN)this._authenticatingRetry=this._send.bind(this,m.STATUS_CHANGE_OP.LOGIN).defer(this.config.retryPeriod,false);break;case 'INVALID_OAUTH_FOR_CURRENT_USER':case 'NO_USER_LOGGED_IN':if(this.state===this.STATES.ONLINE||this.state===this.STATES.WAITING_TO_AUTH){x.debug('user_logged_out');this.goOffline();this._switchToState(this.STATES.LOGGED_OUT_AND_WAITING);return;}else if(this.state===this.STATES.LOGGING_IN){this.oauthTokenInvalid=true;if(!this.fetchedOauth){this._switchToState(this.STATES.FETCHING_OAUTH);new h(this.config.fetch_oauth_url).send();return;}fa=this._authError;}else if(this.manualPlay){this._switchToState(this.STATES.LOGGING_IN);this._send(m.STATUS_CHANGE_OP.LOGIN);}else this._switchToState(this.STATES.LOGGED_OUT_AND_WAITING);break;case 'EXPIRED_OAUTH_TOKEN':case 'LOGIN_BAD_CREDENTIALS':this.oauthTokenInvalid=true;if(!this.fetchedOauth){this._switchToState(this.STATES.FETCHING_OAUTH);new h(this.config.fetch_oauth_url).send();return;}fa=this._authError;break;case 'OAUTH_TOKEN_NOT_VERIFIED':case 'TOKEN_VERIFICATION_TIMEOUT':if(this.state!=this.STATES.WAITING_TO_AUTH){this._switchToState(this.STATES.WAITING_TO_AUTH);this._pollForAP();return;}fa=this._authError;break;case 'INVALID_CSRF_TOKEN':case 'AUTH_FAILED':case 'TOKEN_VERIFICATION_DENIED_TOO_MANY_REQUESTS':fa=this._authError;break;default:x.error('bad_op',{op:ba,payload:ga});break;}fa.call(this,ba,ga);},_loadError:function(ba,ca){x.debug('load_error',{op:ba,error_count:this.error_count+1,data:ca});this.goOffline();},_authError:function(ba,ca){x.error('auth_error',{op:ba,data:ca,error_code:this._getError(ca.error.type)});if(this.state===this.STATES.WAITING_TO_AUTH){this.manualPlay&&this.displayError(4);this.goOffline();return;}if(this.showLoggingin){this._launchPlayNow({step:10});this.showLoggingin=false;}this._cleanupIframe();if(this._iframeTryCount<=this.config.iframeTryCycles){this._switchToState(this.STATES.IFRAME_POLLING);this._makeIframePollRequest();this.responseCallback(m.DIAGNOSTIC_EVENT.IFRAME_POLLING);}else{if(this.manualPlay)j.bootstrap('/ajax/music/login_error.php');this.goOffline();}},_makeIframePollRequest:function(){var ba=s(window.location.href);if(ba.getSubdomain()=='our')ba=ba.setSubdomain('www');var ca=window.location.protocol+'//'+ba.getDomain()+'/',da=s(ca+this.config.csrf_uri).setQueryData({fb_csrf:this.fb_csrf,refresh_token:this.oauthTokenInvalid}),ea=s(this.uri.toString()+this.serverConfig.ops.GET_IFRAME_RESPONSE).setQueryData({set_csrf_path:da.toString(),cbust:this.serial++});this._cleanupIframe();this._iframe=k.create('iframe',{className:'hidden_elem',src:ea});x.debug('iframe_add',ea);document.body.appendChild(this._iframe);var fa=v;if(++this._iframeTryCount<this.config.iframeTryCycles){fa=function(){this._iframeTryCount>1&&x.debug('iframe_retry');this._makeIframePollRequest();};}else fa=function(){x.error('iframe_retry_exceeded');this._pingPortsModeResign();};this._iframePollTimeout=fa.bind(this).defer(this.config.iframeUpdatePeriod,false);},_cleanupIframe:function(){this._iframePollTimeout&&clearTimeout(this._iframePollTimeout);this._iframe&&x.debug('iframe_remove',this._iframe.id);this._iframe&&k.remove(this._iframe);this._iframe=null;},_switchToState:function(ba){x.debug('switch_state',this.state+" => "+ba);n.stateChanged.curry(p.SPOTIFY,this.state,ba).defer();this.inform(m.DIAGNOSTIC_EVENT.STATE_CHANGE,{from:this.state,to:ba});this.state=ba;},_convertURIFields:function(ba){if(!ba)return null;if(ba.track&&ba.track.track_resource){var ca=ba.track;ba.track={uri:ca.track_resource.location.og,name:ca.track_resource.name};if(ca.track_type)ba.track.track_type=ca.track_type;if(ca.artist_resource)ba.track.artist=ca.artist_resource.name;if(ca.album_resource)ba.track.album=ca.album_resource.name;if(ca.length){ba.playing_position=ba.playing_position?Math.floor(ba.playing_position):0;ba.expires_in=ca.length-ba.playing_position;ba.expires_in=ba.expires_in<0?0:ba.expires_in;}}if(ba.context&&ba.context.context_resource&&ba.context.context_resource.location){var da=ba.context;ba.context={uri:da.context_resource.location.og,name:da.context_resource.name};if(da.creator)ba.context.creator=da.creator.real_name;}for(var ea in ba)if(!m.ALLOWED_STATUS_PARAMS[ea])delete ba[ea];n.receiveUpdate.curry(p.SPOTIFY,ba).defer();return ba;},_isValidClient:function(ba,ca){var da=this._providerArgs.blacklisted_versions,ea=this._providerArgs.minimum_version;return this.PROTOCOL_VERSIONS.indexOf(ca)!==-1&&ea&&da&&ba&&da.indexOf(ba)===-1&&m.greaterOrEqualToMinimumVersion(ba,ea);},_getError:function(ba,ca){if(!ca&&!isNaN(parseFloat(ba)))if(ba>=4200&&ba<=4399)return this._errorMap['4200 - 4399'];return this._errorMap[ba];},_errorMap:{'4200 - 4399':'SERVICE_DEPENDENT_ERRORS',4201:1,4202:2,4203:3,4204:4,4205:5,4301:101,4302:102,4303:103,'4000 - 4099':'GENERAL_RPC_ERRORS',4001:'UNKNOWN_METHOD',4002:'ERROR_PARSING_REQUEST',4003:'UNKNOWN_SERVICE',4004:'SERVICE_NOT_RESPONDING','4100 - 4199':'RPC_AUTHENTICATION_ERRORS',4102:'LOGIN_BAD_CREDENTIALS',4103:'EXPIRED_OAUTH_TOKEN',4104:'OAUTH_TOKEN_NOT_VERIFIED',4105:'TOKEN_VERIFICATION_DENIED_TOO_MANY_REQUESTS',4106:'TOKEN_VERIFICATION_TIMEOUT',4107:'INVALID_CSRF_TOKEN',4108:'INVALID_OAUTH_FOR_CURRENT_USER',4109:'INVALID_CSRF_PATH',4110:'NO_USER_LOGGED_IN',LOAD_ERROR:'LOAD_ERROR',TIMEOUT_ERROR:'TIMEOUT_ERROR',PARSE_ERROR:'PARSE_ERROR'}});})();e.exports=a.SpotifyRemote||z;});
__d("WebBridgeRemote",["Event","Arbiter","ArbiterMixin","AsyncRequest","CSS","Dialog","DOM","Env","JSLogger","MusicConstants","MusicDiagnostics","URI","UserAgent","copyProperties","cx","emptyFunction","ge","swfobject2"],function(a,b,c,d,e,f){var g=b('Event'),h=b('Arbiter'),i=b('ArbiterMixin'),j=b('AsyncRequest'),k=b('CSS'),l=b('Dialog'),m=b('DOM'),n=b('Env'),o=b('JSLogger'),p=b('MusicConstants'),q=b('MusicDiagnostics'),r=b('URI'),s=b('UserAgent'),t=b('copyProperties'),u=b('cx'),v=b('emptyFunction'),w=b('ge'),x=b('swfobject2'),y=o.create('music_web_bridge');function z(aa,ba,ca){this.responseCallback=aa;this.provider=ba;if(!ca.external_player)return;this.externalPlayer=this._getExternalPlayer(ca.external_player);this.connectionName=r(this.externalPlayer).getDomain();this.state=z.STATES.OFFLINE;this.lastSentMsg=null;this.wasOnline=false;this.connectionAttempts=0;this.lastStatusCheck=0;h.subscribe('MusicFlashBridge.'+this.provider+'.status',this.reportStatus.bind(this));h.subscribe('MusicFlashBridge.'+this.provider+'.initialized',function(){this._flashBridgeReady.bind(this).defer();}.bind(this));s.osx()&&g.listen(window,'focus',this._onFocus.bind(this));s.osx()&&g.listen(window,'blur',this._onBlur.bind(this));}t(z,{minFlashVersion:'10.3.181.34',flashBridgeSWF:'/music/flash/MusicFlashBridge.swf',configure:function(aa){y.debug('configure',aa);z.minFlashVersion=aa.minFlashVersion;z.flashBridgeSWF=aa.flashBridgeSWF;},STATES:{OFFLINE:'OFFLINE',BRIDGE_WAITING:'BRIDGE_WAITING',BRIDGE_READY:'BRIDGE_READY',ONLINE:'ONLINE'},PLAY_NOW_URL:'/ajax/music/web_bridge_play_now.php?init_only',ERROR_DIALOG:'/ajax/music/play_error.php',TOS_URL:'/music/tos_launch_player.php',OPTIMISTIC_PLAYNOW_TIME:2000,UNLOAD_ON_BLUR_DELAY:3000,REMOTE_CONNECTION_INTERVAL:1500,REMOTE_CONNECTION_TIMEOUT_MANUAL:60,REMOTE_CONNECTION_TIMEOUT_AUTO:5,REMOTE_CONNECTION_RETRY_TIMEOUT:4000,RECHECK_STATUS_ON_SEND_INTERVAL:10000,RECHECK_STATUS_SEND_TIMEOUT:500,hasMinFlashVersion:function(){if(!x.hasFlashPlayerVersion(this.minFlashVersion)){y.bump('flash_upgrade');new j().setURI('/ajax/flash_update_dialog.php').setMethod('GET').setReadOnly(true).send();return false;}return true;},getFlashMovieObject:function(aa){if(document[aa])return document[aa];if(document.embeds&&document.embeds[aa])return document.embeds[aa];return w(aa);},removeFlashMovieObject:function(aa){if(document[aa])document[aa]=null;if(document.embeds&&document.embeds[aa])document.embeds[aa]=null;if(w(aa))m.remove(aa);}});t(z.prototype,i,{responseCallback:v,flashBridge:null,persistFor:0,persistSearchingFor:function(aa){this.connectionAttempts=0;this.persistFor=aa;this.maxConnectAttempts=Math.floor((aa*1000)/z.REMOTE_CONNECTION_INTERVAL);if(this.state===z.STATES.OFFLINE)this._initFlashBridge();},attemptGoOnline:function(aa){var ba=aa?z.REMOTE_CONNECTION_TIMEOUT_MANUAL:z.REMOTE_CONNECTION_TIMEOUT_AUTO;if(ba<this.persistFor)ba=this.persistFor;this.persistSearchingFor(ba);},goOffline:function(){y.log('go_offline',{provider:this.provider,from_state:this.state});this._switchToState(z.STATES.OFFLINE);this._removeFlashBridge();this._resetClientPoll();this.responseCallback(p.DIAGNOSTIC_EVENT.OFFLINE);},serviceRunning:function(){return this.state===z.STATES.ONLINE;},reconnect:function(){},setTokens:function(aa){},send:function(aa,ba){if(this.state===z.STATES.ONLINE){this._resetSendSubscription();var ca=function(){this._resetSendSubscription();this.responseCallback(p.DIAGNOSTIC_EVENT.LOG_SEND_OP,{op:aa,params:ba});this._send(aa,p.sanitizeForProviders(ba));}.bind(this);if(Date.now()-z.RECHECK_STATUS_ON_SEND_INTERVAL>this.lastStatusCheck){this._sendTimer=ca.defer(z.RECHECK_STATUS_SEND_TIMEOUT,false);this._sendSubscription=this.subscribe(p.DIAGNOSTIC_EVENT.MISS,function(da,ea){q.stateChanged(this.provider,null,null,p.DIAGNOSTIC_EVENT.INCORRECT_ONLINE_STATE);this._resetSendSubscription();this.goOffline();this.responseCallback(p.DIAGNOSTIC_EVENT.REQUEUE_OP,{op:aa,params:ba});}.bind(this));this._send(p.STATUS_CHANGE_OP.STATUS,{});}else ca();}else this.responseCallback(p.DIAGNOSTIC_EVENT.REQUEUE_OP,{op:aa,params:ba});},verifyOnlineState:function(aa){if(this.state!==z.STATES.ONLINE){aa();}else{aa.defer(500,false);this._send(p.STATUS_CHANGE_OP.STATUS,{_never_queue:true});}},_resetSendSubscription:function(){this._sendTimer&&clearTimeout(this._sendTimer);this._sendSubscription&&this.unsubscribe(this._sendSubscription);this._sendSubscription=this._sendTimer=null;},_send:function(aa,ba){switch(aa){case p.OP.PLAY:case p.OP.RESUME:case p.OP.PAUSE:this.lastSentMsg={};t(this.lastSentMsg,ba);if(ba.radio_station||ba.album||ba.playlist||ba.musician){delete ba.song_list;}else if(!ba.song)ba.song=ba.uri;delete ba.uri;break;case p.STATUS_CHANGE_OP.STATUS:this.lastStatusCheck=Date.now();break;default:y.error('invalid_op',{provider:this.provider,op:aa});return;}if(this.flashBridge&&!this._unloadIfNeeded()){y.debug('send',{provider:this.provider,op:aa,params:ba});y.rate('flash_movie_valid',(typeof this.flashBridge.send)==='function');this.flashBridge.send(aa,ba);q.sendUpdate.curry(this.provider,aa,ba).defer();}},launch:function(aa,ba,ca,da,ea){var fa=this.provider.replace(/\.|-/g,'_'),ga=r(this.externalPlayer).addQueryData(ba),ha=ga;if(ca)ha=r(z.TOS_URL).addQueryData({player_url:ga.toString(),url:aa,perms:ca,get_dtsg:n.fb_dtsg}).addQueryData(ea);window.open(ha,fa);q.sendUpdate.curry(this.provider,q.WINDOW_OPEN,ba).defer();var ia={url:aa,step:9};if(da)ia=t(ia,da);y.debug('launch',{provider:this.provider,params:ia});this._launchPlayNow(ia);},launchPlayNowDialog:function(aa){if(this.serviceRunning())return;this._resetLaunchSubscription();var ba=this._launchPlayNow.bind(this,aa);this.prePlayNowLaunchTimer=ba.defer(z.OPTIMISTIC_PLAYNOW_TIME,false);this.launchSubscription=this.subscribe([p.DIAGNOSTIC_EVENT.MISS,p.DIAGNOSTIC_EVENT.STATE_CHANGE],function(ca,da){if(ca===p.DIAGNOSTIC_EVENT.MISS){this._resetLaunchSubscription();ba();}else if(da.to===z.STATES.ONLINE){this._resetLaunchSubscription();q.userAction.curry(this.provider,q.LAUNCH_NOT_NEEDED).defer();}}.bind(this));this.attemptGoOnline(true);},reportStatus:function(aa,ba){var ca=ba.op,da=ba.args;clearTimeout(this._pollTimeout);if(da.error_code){q.userAction.curry(this.provider,p.DIAGNOSTIC_EVENT.SERVICE_ERROR,{code:da.error_code}).defer();var ea=p.ERROR[da.error_code];switch(ea){case 'AUDIO_AD_PLAYING':y.log('report_status_ad_playing',{error:ea,provider:this.provider,args:da});break;default:var fa={code:da.error_code,provider:this.provider};if(da.song)fa.song=da.song;if(da.redirect_url)fa.url=da.redirect_url;l.bootstrap(z.ERROR_DIALOG,fa);y.error('report_status_error',{error:ea,provider:this.provider,args:da});return;}}if(da.offline){this.goOffline();}else if(ca===p.DIAGNOSTIC_EVENT.MISS){this.inform(ca,da);if(this.state!==z.STATES.ONLINE&&this.state!==z.STATES.OFFLINE){if(this.connectionAttempts<this.maxConnectAttempts){this._pollForClient.bind(this).defer(z.REMOTE_CONNECTION_INTERVAL,false);}else this.goOffline();}else if(this.state===z.STATES.ONLINE){this.goOffline();if(this.lastSentMsg&&this.lastSentMsg.uri)this.responseCallback(p.DIAGNOSTIC_EVENT.RELAUNCH,{last_sent:this.lastSentMsg});return;}}else if(this.state===z.STATES.BRIDGE_READY){this.wasOnline=true;this._switchToState(z.STATES.ONLINE);this.responseCallback(p.DIAGNOSTIC_EVENT.ONLINE);}if(ca===p.STATUS_CHANGE_OP.STATUS)q.receiveUpdate.curry(this.provider,da).defer();if(da.radio_station||da.song){da.track={};da.track.uri=da.radio_station||da.song;da.track.songuri=da.song;}if(da.radio_station){da.context={name:da.title,uri:da.radio_station};}else if(da.playlist){da.context={name:da.title,uri:da.playlist};}else if(da.album){da.context={name:da.title,uri:da.album};}else if(da.musician)da.context={name:da.title,uri:da.musician};this.responseCallback.apply(this,[ca].concat(da));},_onFocus:function(){clearTimeout(this._blurTimeout);if(!this.wasOnline)return;if(!this.flashBridge){this.persistSearchingFor(z.REMOTE_CONNECTION_TIMEOUT_AUTO);}else{y.rate('flash_movie_valid',(typeof this.flashBridge.activate)==='function');this.flashBridge.activate();}},_onBlur:function(){if(this.flashBridge){clearTimeout(this._blurTimeout);this._blurTimeout=function(){this._unloadIfNeeded();}.bind(this).defer(z.UNLOAD_ON_BLUR_DELAY);}},_unloadIfNeeded:function(){if(this.flashBridge)if(s.osx()){var aa=(typeof this.flashBridge.shouldUnload==='function');y.rate('flash_movie_valid',aa);if(!aa||this.flashBridge.shouldUnload()){this.goOffline();return true;}}return false;},_launchPlayNow:function(aa){var ba=aa&&aa.context&&aa.context.button_id;this._resetLaunchSubscription();l.bootstrap(z.PLAY_NOW_URL,aa,null,null,null,w(ba));},_resetLaunchSubscription:function(){clearTimeout(this.prePlayNowLaunchTimer);this.launchSubscription&&this.unsubscribe(this.launchSubscription);},_initFlashBridge:function(){this.flashBridge=z.getFlashMovieObject(this.provider);if(!this.flashBridge){this._switchToState(z.STATES.BRIDGE_WAITING);var aa=this.provider+'_container';document.body.appendChild(m.create('div',{id:aa}));x.embedSWF(z.flashBridgeSWF,aa,'1px','1px',z.minFlashVersion,null,{swf_id:this.provider,name:this.connectionName,user_id:n.user},{allowscriptaccess:'always'},null,function(ba){y.rate('flash_bridge_init',ba.success);y.debug('flash_bridge_init',ba.success);this.flashBridge=ba.ref;if(this.flashBridge)k.addClass(this.flashBridge,"_2px");}.bind(this));}else this._flashBridgeReady();},_removeFlashBridge:function(){if(this.flashBridge){y.debug('flash_bridge_unload',this.provider);var aa=this.provider+'_container';x.removeSWF(aa);this.flashBridge=null;}},_switchToState:function(aa){y.debug('switch_state',this.provider+": "+this.state+" => "+aa);q.stateChanged.curry(this.provider,this.state,aa).defer();this.inform(p.DIAGNOSTIC_EVENT.STATE_CHANGE,{from:this.state,to:aa});this.state=aa;},_flashBridgeReady:function(){y.debug('flash_bridge_ready',{provider:this.provider,state:this.state});if(this.state!=z.STATES.ONLINE){this._switchToState(z.STATES.BRIDGE_READY);this._pollForClient();}},_resetClientPoll:function(){this.connectionAttempts=0;this.persistFor=0;clearTimeout(this._pollTimeout);},_pollForClient:function(){if(!this.flashBridge||((typeof this.flashBridge.send)!=='function')||this.state==z.STATES.OFFLINE)return;this._send(p.STATUS_CHANGE_OP.STATUS,{});var aa;if(++this.connectionAttempts<this.maxConnectAttempts){aa=function(){if(this.state==z.STATES.OFFLINE)return;y.debug('poll_for_client',{provider:this.provider,connection_attempts:this.connectionAttempts});clearTimeout(this._pollTimeout);this._pollForClient();};}else aa=function(){y.debug('timeout_max_connection_attempts',this.provider);this.goOffline();};this._pollTimeout=aa.bind(this).defer(z.REMOTE_CONNECTION_RETRY_TIMEOUT,false);},_getExternalPlayer:function(aa){return aa;}});e.exports=a.WebBridgeRemote||z;});
__d("Music",["Arbiter","AsyncRequest","Bootloader","ChannelConstants","Dialog","JSLogger","MusicConstants","MusicDiagnostics","MusicEvents","MusicLogger","MusicProviders","MusicWaterfallLogger","Run","SpotifyRemote","WebBridgeRemote","areObjectsEqual","copyProperties","emptyFunction","ge","isEmpty"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('AsyncRequest'),i=b('Bootloader'),j=b('ChannelConstants'),k=b('Dialog'),l=b('JSLogger'),m=b('MusicConstants'),n=b('MusicDiagnostics'),o=b('MusicEvents'),p=b('MusicLogger'),q=b('MusicProviders'),r=b('MusicWaterfallLogger'),s=b('Run'),t=b('SpotifyRemote'),u=b('WebBridgeRemote'),v=b('areObjectsEqual'),w=b('copyProperties'),x=b('emptyFunction'),y=b('ge'),z=b('isEmpty'),aa=l.create('music'),ba=l.create('music_live_listen'),ca={providers:{},queuedCommand:null,lastStatus:{},_searching:{},lastProviderPlaying:null,addRemoteModule:function(da,ea){},init:function(da,ea){aa.debug('init',{music_providers:da,reconnect:ea});for(var fa in da){this._setProviderConfig(fa,w(this._getProviderConfig(fa)||{offline:true},da[fa]));var ga=this._getProviderConfig(fa),ha=this.getRemoteClass(fa);ha.setTokens(ga.tokens,ga.last_used);ea&&ha.reconnect();}this.listenForScrobble();return this;},_getProviderConfig:function(da){return this.providers[da];},_getProviderConfigForLogging:function(da){if(!this._hasProviderConfig(da))return {};var ea=this._getProviderConfig(da);return {offline:ea.offline,last_used:ea.last_used,instance:!!ea.instance};},_setProviderConfig:function(da,ea){this.providers[da]=ea;},_hasProviderConfig:function(da){return !!this._getProviderConfig(da);},persistSearchingFor:function(da,ea){this._searching[da]=true;var fa;if(this._hasProviderConfig(da))fa=this.getRemoteClass(da);fa&&fa.persistSearchingFor&&fa.persistSearchingFor(ea);return this;},getRemoteClass:function(da){if(!this._hasProviderConfig(da)){aa.error('provider_not_inited',da);return null;}var ea=this._getProviderConfig(da);if(!ea.instance){switch(da){case q.SPOTIFY:var fa=new t();fa.init(this._receiveUpdate.bind(this,da),ea);ea.instance=fa;break;default:var ga=new u(this._receiveUpdate.bind(this,da),da,ea);ea.instance=ga;break;}if(!ea.instance)aa.error('provider_module_not_loaded',da);}return ea.instance;},listenForScrobble:function(){g.subscribe(j.getArbiterType('music_scrobbling'),function(da,ea){if(ea.obj.provider_name){ea.obj.provider_data&&this.init(ea.obj.provider_data);this._resetQueuedCommand(ea.obj.provider_name);this.goOnline(ea.obj.provider_name);}}.bind(this));this.listenForScrobble=x;},goOnline:function(da){var ea=(da in this.providers);if(this._isOffline(da)){var fa=this.isManualPlay(da),ga=ea&&this.getRemoteClass(da);ga&&ga.attemptGoOnline(fa);if(!this._searching[da]&&fa&&(!ga||!ga.serviceRunning())){this.persistSearchingFor(da,60);this.launchPlayNowDialog(da,this.queuedCommand.data);}}return this;},goOffline:function(da,ea,fa){if(this._hasProviderConfig(da)){this._resetQueuedCommand(da);this._searching[da]=null;this.getRemoteClass(da).goOffline();}return this;},allProvidersOffline:function(){for(var da in this.providers)if(!this._isOffline(da))return false;return true;},allProvidersPaused:function(){for(var da in this.providers){var ea=this._getLastStatus(da);if(ea&&ea.playing)return false;}return true;},playPauseSongList:function(da,ea,fa,ga,ha){w(ha||{},{song_list:fa,title:ga||''});return this.playPauseSong(da,ea,ha);},playOrResumeSongList:function(da,ea,fa,ga,ha,ia){w(ha||{},{song_list:fa,title:ga||''});var ja=!!this._getProviderConfig(da);if(ia){this.resume(da,ea,ha);}else this.playSong(da,ea,ha);return ja&&this.getRemoteClass(da).serviceRunning();},playPauseSong:function(da,ea,fa){if(!da){da=this.lastProviderPlaying;if(!da)aa.error('undefined_provider',da);}aa.debug('play_pause_song',{provider:da,provider_config:this._getProviderConfigForLogging(da),uri:ea,data:fa});r.playPause(da);var ga=this._hasProviderConfig(da)?this._getLastStatus(da):{},ha=ga.track&&m.sameURLs(ea,ga.track.uri),ia=ga.context&&m.sameURLs(ea,ga.context.uri),ja=ha||ia;if(ga.playing&&ja){this.pause(da,ea,fa);}else if(ja){this.resume(da,ea,fa);}else this.playSong(da,ea,fa);return this._hasProviderConfig(da)&&this.getRemoteClass(da).serviceRunning();},pauseOtherProviders:function(da){for(var ea in this.providers)if(ea!=da&&!this._isOffline(ea))this.pause(ea);},launchProviderOrPlay:function(da,ea,fa,ga,ha,ia,ja,ka){if(ha){this._diagLogAction(ha,n.SWITCHED_PROVIDER);this.goOffline(ha);}if(!this._isOffline(da)){this.playSong(da,ea,fa);var la=k.getCurrent();la&&la.hide();}else if(da==q.SPOTIFY){this.persistSearchingFor(da,60);this._diagLogAction(da,n.ATTEMPTING_LAUNCH,fa);this.launchPlayNowDialog(da,w({uri:ea},fa),true);}else{!ha&&p.log(p.BUMP_KEY,{provider:da,step:4,status:'okay'});var ma={};ma[da]=ga;this.init(ma);this.launchBridgeProvider(da,ea,fa,ia,ja,ka);this.playSongSafeQueue(da,ea,fa);}},launchBridgeProvider:function(da,ea,fa,ga,ha,ia){if(da==q.SPOTIFY)aa.error('invalid_bridge_provider',da);if(!this._isOffline(da)){var ja=k.getCurrent();ja&&ja.hide();return;}this.persistSearchingFor(da,60);var ka=m.sanitizeForProviders(fa);this.getRemoteClass(da).launch(ea,ka,ga,ha,ia);},launchPlayNowDialog:function(da,ea,fa){if(fa)this.queuedCommand={provider:da,op:m.OP.PLAY,data:ea};var ga=w({},ea),ha={url:ga.uri||ga.url,context:ga,listen_to:ga.listen_to||null,button_id:ga.button_id||null};delete ha.context.uri;delete ha.context.url;delete ha.context.listen_to;delete ha.context.button_id;if(this._hasProviderConfig(da)){this.getRemoteClass(da).launchPlayNowDialog(ha);}else{var ia;if(da===q.SPOTIFY){ia='/ajax/music/spotify_play_now.php?init_only';}else ia='/ajax/music/web_bridge_play_now.php?init_only';k.bootstrap(ia,ha,null,null,null,y(ha.button_id));}},playSongSafeQueue:function(da,ea,fa){if(!this._isOffline(da)||!this.queuedCommand||this.queuedCommand.provider!==da){this.playSong(da,ea,fa);}else this._hasProviderConfig(da)&&this.goOnline(da);},playSong:function(da,ea,fa,ga){fa=w(fa||{},{uri:ea});if(ga&&ga.id&&!fa.button_id)fa.button_id=ga.id;this._sendOP(da,m.OP.PLAY,fa);},pause:function(da,ea,fa){fa=w(fa||{},{uri:ea||null});this._sendOP(da,m.OP.PAUSE,fa);},resume:function(da,ea,fa){fa=w(fa||{},{uri:ea});this._sendOP(da,m.OP.RESUME,fa);},queueLiveListenSession:function(da,ea){this.queuedCommand={op:m.LIVE_LISTEN_OP.QUEUE_SESSION,provider:ea,data:da};},attemptLiveListenSessionForProvider:function(da,ea){if(!this._isOffline(ea)&&ea!==q.SPOTIFY){this.getRemoteClass(ea).verifyOnlineState(this._attemptLiveListenSession.bind(this,da,ea));}else this._attemptLiveListenSession(da,ea);},_attemptLiveListenSession:function(da,ea){if(this._isOffline(ea)){this.queueLiveListenSession(da,ea);this.goOnline(ea);}else this._handleQueuedLiveListenSession(da);},_handleQueuedLiveListenSession:function(da){if(!this._checkForValidSpotifyClient(da))return;if(this._privateListeningIsEnabled(da.provider)){this.getRemoteClass(da.provider).send(m.STATUS_CHANGE_OP.STATUS,{});setTimeout(function(ea){var fa=this._privateListeningIsEnabled(ea.provider);if(fa){var ga=w({listen_to:ea.listen_to,provider:ea.provider},fa),ha=new h().setData(ga).setMethod('POST').setURI('/ajax/music/live_listen_private_listening_dialog.php').setErrorHandler(x);new k().setAsync(ha).show();return;}this._handleQueuedLiveListenSession(ea);}.bind(this,da),3000);return;}ba.log('queued_session',da);p.log(p.BUMP_KEY,{provider:da.provider,step:501,status:'okay'});new h().setURI('/ajax/music/live_listen.php').setData(da).setHandler(x).setAllowCrossPageTransition(true).send();},_checkForValidSpotifyClient:function(da){if(da.provider==q.SPOTIFY){var ea=this.getLastStatus(da.provider);if(!z(ea)&&ea.client_version&&!m.greaterOrEqualToMinimumVersion(ea.client_version,m.LIVE_LISTEN_MIN_SPOTIFY_VERSION)){var fa=new h().setData({listen_to:da.listen_to}).setMethod('POST').setURI('/ajax/music/live_listen_version_dialog.php').setErrorHandler(x);new k().setAsync(fa).show();return false;}}return true;},_privateListeningIsEnabled:function(da){var ea=this.getLastStatus(da);if(!z(ea)&&ea.open_graph_state&&(ea.open_graph_state.posting_disabled||ea.open_graph_state.private_session))return {posting_disabled:ea.open_graph_state.posting_disabled,private_session:ea.open_graph_state.private_session};if(!z(ea)&&ea.post_open_graph&&(ea.post_open_graph.open_graph_disabled||ea.post_open_graph.private_session))return {posting_disabled:ea.post_open_graph.open_graph_disabled,private_session:ea.post_open_graph.private_session};return false;},reInform:function(da){var ea=[];for(var fa=0;fa<da.length;fa++){var ga=da[fa];if(!this._isOffline(ga))if(ga==this.lastProviderPlaying){ea.push(ga);}else ea.unshift(ga);}for(var fa=0;fa<ea.length;fa++){var ga=ea[fa];aa.debug('re_inform',ga);this._receive_STATUS_CHANGE_OP(ga,m.STATUS_CHANGE_OP.REINFORM,this.lastStatus[ga],{});}return this;},isManualPlay:function(da){return !!(this.queuedCommand&&this.queuedCommand.provider===da);},isPlaying:function(da,ea){var fa=this.getLastStatus(da);return fa.playing&&fa.track&&(!ea||m.sameURLs(fa.track.uri,ea));},getLastStatus:function(da){return this._hasProviderConfig(da)?this._getLastStatus(da):{};},_resetQueuedCommand:function(da){if(!da||this.queuedCommand&&this.queuedCommand.provider==da)this.queuedCommand=null;},_receiveUpdate:function(da,ea,fa){aa.debug('receive_update',{provider:da,op:ea,data:fa,provider_config:this._getProviderConfigForLogging(da)});if(fa){fa.provider=da;}else fa={provider:da};var ga=x;if(m.DIAGNOSTIC_EVENT[ea]){ga=this._receiveDIAG_EVENT;}else if(m.STATUS_CHANGE_OP[ea]){ga=this._receive_STATUS_CHANGE_OP;}else !m.OP[ea];ga.call(this,da,ea,fa);},_receiveDIAG_EVENT:function(da,ea,fa){var ga=m.DIAGNOSTIC_EVENT;if(ea===ga.ONLINE){this._setOffline(da,false);if(this.queuedCommand&&this.queuedCommand.provider==da)s.onAfterLoad(this._replayQueuedCommand.bind(this,this.queuedCommand.provider,this.queuedCommand.op,this.queuedCommand.data));this._resetQueuedCommand();}else if(ea===ga.IFRAME_POLLING){this._setLastStatus(da,{});}else if(ea===ga.RELAUNCH&&fa.last_sent){this.launchPlayNowDialog(da,fa.last_sent,true);}else if(ea===ga.LOG_SEND_OP){this._logSendOp(da,fa.op,fa.params,fa.replay);}else if(ea===ga.REQUEUE_OP)this._queueAndGoOnline(da,fa.op,fa.params);o.inform(ga[ea],fa);if(ea===ga.OFFLINE){this._setOffline(da,true);this._setLastStatus(da,{});if(this.allProvidersOffline())o.inform(m.DIAGNOSTIC_EVENT.ALL_OFFLINE);}},_receive_STATUS_CHANGE_OP:function(da,ea,fa,ga){ga=ga||this._getLastStatus(da);var ha;for(ha in ga)if(typeof fa[ha]==='undefined')fa[ha]=null;var ia,ja={};this._setLastStatus(da,fa);for(ha in fa){ia=m.STATUS_CHANGE_EVENT[ha];if(ia)if(!ja[ia]&&!v(ga[ha],fa[ha])){if(ea!==m.STATUS_CHANGE_OP.REINFORM)p.log(p.STATUS_EVENT_VIA,{op:ea,provider:da,data:fa});if(fa.playing){if(this.lastProviderPlaying!=da)this.pauseOtherProviders(da);this.lastProviderPlaying=da;}else if(this.allProvidersPaused())o.inform(m.DIAGNOSTIC_EVENT.ALL_PAUSED);o.inform(ia,fa);ja[ia]=1;}}},_replayQueuedCommand:function(da,ea,fa){if(ea===m.OP.PLAY&&this.isPlaying(da,fa.uri))return;aa.debug('replay_queued_command',da+":"+ea);if(ea===m.LIVE_LISTEN_OP.QUEUE_SESSION){this._handleQueuedLiveListenSession(fa);return;}fa._isReplayedCommand=true;this._sendOP(da,ea,fa);},_sendOP:function(da,ea,fa){aa.debug('send_op',{provider:da,provider_config:this._getProviderConfigForLogging(da),op:ea,data:fa});if(!this._hasProviderConfig(da)){this._queueAndGoOnline(da,ea,fa);}else this.getRemoteClass(da).send(ea,fa);},_logSendOp:function(da,ea,fa){var ga=ea===m.OP.PLAY;if(!fa._isReplayedCommand&&ga)this._diagLogAction(da,n.LAUNCH_NOT_NEEDED);p.log(p.STATUS_EVENT_VIA,{op:ea,provider:da,data:fa});ga&&this._diagLogAction(da,n.PLAY_SONG,fa);},_queueAndGoOnline:function(da,ea,fa){aa.debug('queue_and_go_online',{provider:da,op:ea,data:fa});if(!fa._never_queue)this.queuedCommand={op:ea,data:fa,provider:da};if(ea===m.OP.PLAY)this._diagLogAction(da,n.ATTEMPTING_LAUNCH,fa);this.goOnline(da);},_isOffline:function(da){if(!this._hasProviderConfig(da))return true;return this._getProviderConfig(da).offline;},_setOffline:function(da,ea){if(!this._hasProviderConfig(da))return this;this._searching[da]=null;this._getProviderConfig(da).offline=ea;if(!ea&&!this.lastProviderPlaying){this.lastProviderPlaying=da;}else if(ea&&this.lastProviderPlaying==da){this.lastProviderPlaying=null;for(var fa in this.providers)if(this.isPlaying(fa)){this.lastProviderPlaying=fa;break;}else if(!this._isOffline(fa))this.lastProviderPlaying=fa;}return this;},_getLastStatus:function(da){if(!this._hasProviderConfig(da))return {};return this.lastStatus[da]||{};},_setLastStatus:function(da,ea){if(!this._hasProviderConfig(da))return this;this.lastStatus[da]=ea;return this;},_diagLogAction:function(da,ea,fa){n.userAction.curry(da,ea,fa).defer();}};g.subscribe(j.getArbiterType('livelisten_update'),function(da,ea){i.loadModules(['MusicLiveListen'],function(fa){fa.handleUpdate(ea.obj);});});e.exports=ca;a.Music=ca;});
__d("legacy:Music",["Music"],function(a,b,c,d){a.Music=b('Music');},3);